-- =============================================
-- AM BOT FIXED - B·∫ÆN THEO TARGET D√ô CLICK ƒê√ÇU
-- =============================================

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer
local mouse = player:GetMouse()

-- Bi·∫øn to√†n c·ª•c
local isAutoClicking = false
local isESP = false
local connectionClick, connectionESP = nil, nil
local currentTarget = nil
local espBoxes = {}
local playerConnections = {}

-- ================== GIAO DI·ªÜN ==================
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "AmbotGUIFixed"
screenGui.Parent = game:GetService("CoreGui") or player.PlayerGui

local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 200, 0, 150)
mainFrame.Position = UDim2.new(0, 20, 0, 20)
mainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
mainFrame.BorderSizePixel = 2
mainFrame.BorderColor3 = Color3.fromRGB(80, 80, 120)
mainFrame.Active = true
mainFrame.Draggable = true
mainFrame.Parent = screenGui

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, 0, 0, 30)
title.Position = UDim2.new(0, 0, 0, 0)
title.BackgroundColor3 = Color3.fromRGB(40, 40, 60)
title.TextColor3 = Color3.fromRGB(255, 100, 100)
title.Text = "üéØ AM BOT FIXED üéØ"
title.Font = Enum.Font.SourceSansBold
title.TextSize = 18
title.Parent = mainFrame

-- N√∫t Auto Click
local autoClickButton = Instance.new("TextButton")
autoClickButton.Size = UDim2.new(0.9, 0, 0, 35)
autoClickButton.Position = UDim2.new(0.05, 0, 0.22, 0)
autoClickButton.BackgroundColor3 = Color3.fromRGB(60, 60, 80)
autoClickButton.TextColor3 = Color3.fromRGB(255, 255, 255)
autoClickButton.Text = "üî´ AUTO CLICK: OFF"
autoClickButton.Font = Enum.Font.SourceSansBold
autoClickButton.TextSize = 14
autoClickButton.Parent = mainFrame

-- N√∫t ESP
local espButton = Instance.new("TextButton")
espButton.Size = UDim2.new(0.9, 0, 0, 35)
espButton.Position = UDim2.new(0.05, 0, 0.55, 0)
espButton.BackgroundColor3 = Color3.fromRGB(60, 60, 80)
espButton.TextColor3 = Color3.fromRGB(255, 255, 255)
espButton.Text = "üì° ESP: OFF"
espButton.Font = Enum.Font.SourceSansBold
espButton.TextSize = 14
espButton.Parent = mainFrame

-- Status label
local statusLabel = Instance.new("TextLabel")
statusLabel.Size = UDim2.new(0.9, 0, 0, 25)
statusLabel.Position = UDim2.new(0.05, 0, 0.85, 0)
statusLabel.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
statusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
statusLabel.Text = "READY"
statusLabel.Font = Enum.Font.SourceSans
statusLabel.TextSize = 12
statusLabel.Parent = mainFrame

-- ================== H√ÄM T√åM TARGET G·∫¶N NH·∫§T ==================
function findNearestTarget()
    local nearestPlayer = nil
    local nearestDistance = math.huge
    local localCharacter = player.Character
    local localRoot = localCharacter and localCharacter:FindFirstChild("HumanoidRootPart")
    
    if not localRoot then return nil end
    
    for _, otherPlayer in pairs(Players:GetPlayers()) do
        if otherPlayer ~= player and otherPlayer.Character then
            local humanoid = otherPlayer.Character:FindFirstChildOfClass("Humanoid")
            if humanoid and humanoid.Health > 0 then -- Ch·ªâ target ng∆∞·ªùi c√≤n s·ªëng
                local otherRoot = otherPlayer.Character:FindFirstChild("HumanoidRootPart")
                if otherRoot then
                    local distance = (localRoot.Position - otherRoot.Position).Magnitude
                    if distance < nearestDistance then
                        nearestDistance = distance
                        nearestPlayer = otherPlayer
                    end
                end
            end
        end
    end
    
    return nearestPlayer, nearestDistance
end

-- ================== H√ÄM B·∫ÆN V√ÄO TARGET ==================
function shootAtTarget(targetPlayer)
    if not targetPlayer or not targetPlayer.Character then return false end
    
    local character = targetPlayer.Character
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    local head = character:FindFirstChild("Head")
    local torso = character:FindFirstChild("Torso") or character:FindFirstChild("UpperTorso")
    
    if not humanoid or humanoid.Health <= 0 then return false end
    
    local targetPart = head or torso or character:FindFirstChild("HumanoidRootPart")
    if not targetPart then return false end
    
    -- T·∫°o raycast t·ª´ camera ƒë·∫øn target
    local camera = Workspace.CurrentCamera
    local rayOrigin = camera.CFrame.Position
    local rayDirection = (targetPart.Position - rayOrigin).Unit * 1000
    
    local ray = Ray.new(rayOrigin, rayDirection)
    local raycastParams = RaycastParams.new()
    raycastParams.FilterDescendantsInstances = {player.Character}
    raycastParams.FilterType = Enum.RaycastFilterType.Blacklist
    
    local rayResult = Workspace:Raycast(ray.Origin, ray.Direction, raycastParams)
    
    if rayResult then
        local hitPart = rayResult.Instance
        local hitPlayer = Players:GetPlayerFromCharacter(hitPart.Parent)
        
        if hitPlayer == targetPlayer then
            -- Th·ª≠ c√°c ph∆∞∆°ng ph√°p fire remote event
            local success = pcall(function()
                -- Method 1: T√¨m remote event ph·ªï bi·∫øn
                local remotes = {
                    "DamageEvent", "HitEvent", "ShootEvent", "Damage",
                    "Fire", "Attack", "RemoteEvent", "RE"
                }
                
                for _, remoteName in pairs(remotes) do
                    local remote = game:GetService("ReplicatedStorage"):FindFirstChild(remoteName)
                    if remote and remote:IsA("RemoteEvent") then
                        remote:FireServer({
                            target = humanoid,
                            damage = 25,
                            part = hitPart,
                            origin = rayOrigin,
                            direction = rayDirection
                        })
                        return true
                    end
                end
                
                -- Method 2: T√¨m trong workspace
                for _, obj in pairs(Workspace:GetDescendants()) do
                    if obj:IsA("RemoteEvent") and obj.Name:lower():find("hit") then
                        obj:FireServer(humanoid, 25, hitPart)
                        return true
                    end
                end
                
                -- Method 3: Fire mouse event
                mouse.Target = hitPart
                mouse.TargetFilter = hitPart
                
                -- Fire click detector n·∫øu c√≥
                local clickDetector = hitPart:FindFirstChildOfClass("ClickDetector")
                if clickDetector then
                    fireclickdetector(clickDetector)
                end
                
                return true
            end)
            
            return success
        end
    end
    
    return false
end

-- ================== CH·ª®C NƒÇNG AUTO CLICK ==================
function startAutoClick()
    connectionClick = RunService.RenderStepped:Connect(function()
        -- T√¨m target m·ªõi n·∫øu ch∆∞a c√≥ ho·∫∑c target ƒë√£ ch·∫øt
        if not currentTarget or not currentTarget.Character or 
           currentTarget.Character:FindFirstChildOfClass("Humanoid").Health <= 0 then
            currentTarget = findNearestTarget()
        end
        
        if currentTarget then
            -- Ki·ªÉm tra n·∫øu ƒëang nh·∫•n chu·ªôt tr√°i
            if UserInputService:IsMouseButtonPressed(Enum.UserInputType.MouseButton1) then
                local success = shootAtTarget(currentTarget)
                
                -- Update status
                local distance = 0
                local localRoot = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
                local targetRoot = currentTarget.Character and currentTarget.Character:FindFirstChild("HumanoidRootPart")
                
                if localRoot and targetRoot then
                    distance = (localRoot.Position - targetRoot.Position).Magnitude
                end
                
                statusLabel.Text = string.format("üî´: %s (%.1f studs)", currentTarget.Name, distance)
                
                -- Th√™m delay nh·ªè ƒë·ªÉ tr√°nh spam
                task.wait(0.05)
            else
                statusLabel.Text = string.format("TARGET: %s (Hold LMB)", currentTarget.Name)
            end
        else
            statusLabel.Text = "NO TARGET FOUND"
        end
    end)
end

-- ================== ESP SYSTEM FIXED ==================
function createESPBox(targetPlayer)
    if not targetPlayer or not targetPlayer.Character then return end
    
    -- X√≥a ESP c≈© n·∫øu c√≥
    if espBoxes[targetPlayer] then
        espBoxes[targetPlayer]:Destroy()
        espBoxes[targetPlayer] = nil
    end
    
    local function updateESP()
        if not targetPlayer or not targetPlayer.Character then return end
        
        local character = targetPlayer.Character
        local humanoid = character:FindFirstChildOfClass("Humanoid")
        
        if not humanoid then return end
        
        -- T·∫°o box m·ªõi n·∫øu ch∆∞a c√≥
        if not espBoxes[targetPlayer] or not espBoxes[targetPlayer].Parent then
            local espBox = Instance.new("BillboardGui")
            espBox.Name = "ESP_" .. targetPlayer.Name
            espBox.Size = UDim2.new(4, 0, 6, 0)
            espBox.AlwaysOnTop = true
            espBox.ClipsDescendants = true
            espBox.MaxDistance = 500
            espBox.Parent = character
            
            local espFrame = Instance.new("Frame")
            espFrame.Size = UDim2.new(1, 0, 1, 0)
            espFrame.BackgroundTransparency = 0.8
            espFrame.BorderSizePixel = 2
            espFrame.BorderColor3 = Color3.fromRGB(255, 50, 50)
            espFrame.BackgroundColor3 = Color3.fromRGB(255, 50, 50, 0.1)
            espFrame.Parent = espBox
            
            local espName = Instance.new("TextLabel")
            espName.Size = UDim2.new(1, 0, 0.2, 0)
            espName.Position = UDim2.new(0, 0, -0.25, 0)
            espName.BackgroundTransparency = 1
            espName.TextColor3 = Color3.fromRGB(255, 100, 100)
            espName.Text = targetPlayer.Name
            espName.Font = Enum.Font.SourceSansBold
            espName.TextSize = 14
            espName.TextStrokeTransparency = 0.5
            espName.Parent = espBox
            
            local espHealth = Instance.new("TextLabel")
            espHealth.Size = UDim2.new(1, 0, 0.2, 0)
            espHealth.Position = UDim2.new(0, 0, 1, 0)
            espHealth.BackgroundTransparency = 1
            espHealth.TextColor3 = Color3.fromRGB(100, 255, 100)
            espHealth.Font = Enum.Font.SourceSans
            espHealth.TextSize = 12
            espHealth.TextStrokeTransparency = 0.5
            espHealth.Parent = espBox
            
            -- G·∫Øn v√†o HumanoidRootPart
            local rootPart = character:FindFirstChild("HumanoidRootPart")
            if rootPart then
                espBox.Adornee = rootPart
            else
                espBox.Adornee = humanoid
            end
            
            espBoxes[targetPlayer] = espBox
        end
        
        -- C·∫≠p nh·∫≠t th√¥ng tin
        local espBox = espBoxes[targetPlayer]
        if espBox and espBox.Parent then
            local healthText = espBox:FindFirstChild("HealthText") or espBox:FindFirstChildWhichIsA("TextLabel", true)
            if healthText then
                healthText.Text = "HP: " .. math.floor(humanoid.Health) .. "/" .. math.floor(humanoid.MaxHealth)
                
                -- ƒê·ªïi m√†u theo health
                local healthPercent = humanoid.Health / humanoid.MaxHealth
                local frame = espBox:FindFirstChildWhichIsA("Frame")
                if frame then
                    if healthPercent > 0.7 then
                        frame.BorderColor3 = Color3.fromRGB(100, 255, 100)
                    elseif healthPercent > 0.3 then
                        frame.BorderColor3 = Color3.fromRGB(255, 255, 100)
                    else
                        frame.BorderColor3 = Color3.fromRGB(255, 50, 50)
                    end
                end
            end
            
            -- Hi·ªÉn th·ªã kho·∫£ng c√°ch
            local localRoot = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
            local targetRoot = character:FindFirstChild("HumanoidRootPart")
            
            if localRoot and targetRoot then
                local distance = (localRoot.Position - targetRoot.Position).Magnitude
                local distanceText = espBox:FindFirstChild("DistanceText")
                if not distanceText then
                    distanceText = Instance.new("TextLabel")
                    distanceText.Name = "DistanceText"
                    distanceText.Size = UDim2.new(1, 0, 0.2, 0)
                    distanceText.Position = UDim2.new(0, 0, 1.2, 0)
                    distanceText.BackgroundTransparency = 1
                    distanceText.TextColor3 = Color3.fromRGB(100, 150, 255)
                    distanceText.Font = Enum.Font.SourceSans
                    distanceText.TextSize = 11
                    distanceText.TextStrokeTransparency = 0.5
                    distanceText.Parent = espBox
                end
                distanceText.Text = string.format("%.1f studs", distance)
            end
        end
    end
    
    -- K·∫øt n·ªëi s·ª± ki·ªán character thay ƒë·ªïi
    if playerConnections[targetPlayer] then
        playerConnections[targetPlayer]:Disconnect()
    end
    
    playerConnections[targetPlayer] = targetPlayer.CharacterAdded:Connect(function(newChar)
        task.wait(0.5) -- ƒê·ª£i character load
        if isESP then
            createESPBox(targetPlayer)
        end
    end)
    
    -- B·∫Øt ƒë·∫ßu update loop
    local espLoop
    espLoop = RunService.RenderStepped:Connect(function()
        if not isESP or not targetPlayer or not targetPlayer.Parent then
            espLoop:Disconnect()
            return
        end
        
        if targetPlayer.Character then
            updateESP()
        else
            -- X√≥a ESP n·∫øu kh√¥ng c√≥ character
            if espBoxes[targetPlayer] then
                espBoxes[targetPlayer]:Destroy()
                espBoxes[targetPlayer] = nil
            end
        end
    end)
end

function updateAllESP()
    -- X√≥a t·∫•t c·∫£ ESP c≈©
    for targetPlayer, espBox in pairs(espBoxes) do
        if espBox then
            espBox:Destroy()
        end
    end
    espBoxes = {}
    
    -- Ng·∫Øt t·∫•t c·∫£ connections c≈©
    for _, connection in pairs(playerConnections) do
        connection:Disconnect()
    end
    playerConnections = {}
    
    -- T·∫°o ESP m·ªõi cho t·∫•t c·∫£ player
    for _, otherPlayer in pairs(Players:GetPlayers()) do
        if otherPlayer ~= player then
            createESPBox(otherPlayer)
        end
    end
end

function removeAllESP()
    for targetPlayer, espBox in pairs(espBoxes) do
        if espBox then
            espBox:Destroy()
        end
    end
    espBoxes = {}
    
    for _, connection in pairs(playerConnections) do
        connection:Disconnect()
    end
    playerConnections = {}
    
    if connectionESP then
        connectionESP:Disconnect()
        connectionESP = nil
    end
end

-- ================== TOGGLE FUNCTIONS ==================
function toggleAutoClick()
    isAutoClicking = not isAutoClicking
    
    if isAutoClicking then
        autoClickButton.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
        autoClickButton.Text = "üî´ AUTO CLICK: ON"
        startAutoClick()
    else
        autoClickButton.BackgroundColor3 = Color3.fromRGB(60, 60, 80)
        autoClickButton.Text = "üî´ AUTO CLICK: OFF"
        
        if connectionClick then
            connectionClick:Disconnect()
            connectionClick = nil
        end
        currentTarget = nil
        statusLabel.Text = "READY"
    end
end

function toggleESP()
    isESP = not isESP
    
    if isESP then
        espButton.BackgroundColor3 = Color3.fromRGB(0, 100, 200)
        espButton.Text = "üì° ESP: ON"
        updateAllESP()
    else
        espButton.BackgroundColor3 = Color3.fromRGB(60, 60, 80)
        espButton.Text = "üì° ESP: OFF"
        removeAllESP()
    end
end

-- ================== SETUP UI ==================
autoClickButton.MouseButton1Click:Connect(toggleAutoClick)
espButton.MouseButton1Click:Connect(toggleESP)

-- Hi·ªáu ·ª©ng hover
local function setupButtonHover(button)
    button.MouseEnter:Connect(function()
        if button == autoClickButton and not isAutoClicking then
            button.BackgroundColor3 = Color3.fromRGB(80, 80, 100)
        elseif button == espButton and not isESP then
            button.BackgroundColor3 = Color3.fromRGB(80, 80, 100)
        end
    end)
    
    button.MouseLeave:Connect(function()
        if button == autoClickButton then
            button.BackgroundColor3 = isAutoClicking and Color3.fromRGB(0, 150, 0) or Color3.fromRGB(60, 60, 80)
        elseif button == espButton then
            button.BackgroundColor3 = isESP and Color3.fromRGB(0, 100, 200) or Color3.fromRGB(60, 60, 80)
        end
    end)
end

setupButtonHover(autoClickButton)
setupButtonHover(espButton)

-- Hotkeys
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if not gameProcessed then
        if input.KeyCode == Enum.KeyCode.F1 then
            toggleAutoClick()
        elseif input.KeyCode == Enum.KeyCode.F2 then
            toggleESP()
        end
    end
end)

-- Auto update ESP khi c√≥ ng∆∞·ªùi ch∆°i m·ªõi
Players.PlayerAdded:Connect(function(newPlayer)
    if isESP then
        task.wait(1) -- ƒê·ª£i character load
        createESPBox(newPlayer)
    end
end)

Players.PlayerRemoving:Connect(function(leavingPlayer)
    if espBoxes[leavingPlayer] then
        espBoxes[leavingPlayer]:Destroy()
        espBoxes[leavingPlayer] = nil
    end
    
    if playerConnections[leavingPlayer] then
        playerConnections[leavingPlayer]:Disconnect()
        playerConnections[leavingPlayer] = nil
    end
end)

-- ================== KH·ªûI ƒê·ªòNG ==================
print("=========================================")
print("üéØ AM BOT FIXED LOADED üéØ")
print("=========================================")
print("üî´ AUTO CLICK: B·∫≠t l√™n -> Target player g·∫ßn nh·∫•t")
print("                 -> Gi·ªØ chu·ªôt tr√°i ƒë·ªÉ b·∫Øn")
print("                 -> B·∫Øn v√†o target d√π click ƒë√¢u")
print("")
print("üì° ESP: Hi·ªÉn th·ªã box, t√™n, HP, kho·∫£ng c√°ch")
print("       T·ª± ƒë·ªông c·∫≠p nh·∫≠t khi player h·ªìi sinh")
print("")
print("Hotkeys:")
print("F1: Toggle Auto Click")
print("F2: Toggle ESP")
print("=========================================")

-- Watermark
local watermark = Instance.new("TextLabel")
watermark.Size = UDim2.new(0, 200, 0, 20)
watermark.Position = UDim2.new(1, -210, 0, 10)
watermark.BackgroundTransparency = 1
watermark.TextColor3 = Color3.fromRGB(255, 100, 100)
watermark.Text = "AM BOT FIXED | Click ƒë√¢u c≈©ng b·∫Øn target"
watermark.Font = Enum.Font.SourceSans
watermark.TextSize = 12
watermark.TextStrokeTransparency = 0.5
watermark.Parent = screenGui